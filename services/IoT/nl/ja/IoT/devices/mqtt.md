---

copyright:
  years: 2015, 2016

---

{:new_window: target="\_blank"}
{:shortdesc: .shortdesc}
{:screen: .screen}
{:codeblock: .codeblock}
{:pre: .pre}


# デバイスの MQTT 接続
{: #mqtt}
最終更新日: 2016 年 9 月 9 日
{: .last-updated}

MQTT は、デバイスとアプリケーションが {{site.data.keyword.iot_full}} と通信するために使用する主要なプロトコルです。デバイスを {{site.data.keyword.iot_short_notm}} と接続/統合する際に役立つクライアント・ライブラリー、情報、サンプルが提供されています。
{:shortdesc}

## クライアント接続
{: #client_connections}

クライアント・セキュリティーの詳細と、MQTT クライアントを {{site.data.keyword.iot_short_notm}} のデバイスに接続する方法については、[{{site.data.keyword.iot_short_notm}} へのアプリケーション、デバイス、ゲートウェイの接続](../reference/security/connect_devices_apps_gw.html)を参照してください。


## Quickstart サービスへのデバイスの接続
{: #connecting_devices}

Quickstart サービスは、最速レベルのサービスです。これは、受信確認を提供せず、MQTT サービス品質 (QoS) レベル 0 より上をサポートしていません。Quickstart サービスに接続する際、認証または登録は必要なく、`orgId` を `quickstart` に設定する必要があります。

Quickstart で使用するデバイス・コードを作成する場合、以下の {{site.data.keyword.iot_short_notm}} サービス機能は Quickstart モードでサポートされません。

-  コマンドへのサブスクライブ
-  デバイス管理プロトコル
-  クリーンまたは永続的セッション

**重要:** 毎秒 1 個より速い速度でデバイスから送信されるメッセージは破棄される可能性があります。


## MQTT 認証
{: #mqtt_authentication}

ゲートウェイやデバイスでは、{{site.data.keyword.iot_short_notm}} は MQTT トークン・ベース認証を使用します。

MQTT 認証を有効にするには、MQTT 接続を行う際にユーザー名とパスワードをサブミットします。

### ユーザー名

ユーザー名は、すべてのデバイスで同じ値 `use-token-auth` です。この値により、{{site.data.keyword.iot_short_notm}} はデバイスの認証トークンを使用するようになります。これは、パスワードとして指定されます。

### パスワード

各デバイスのパスワードは、デバイスが {{site.data.keyword.iot_short_notm}} に登録されたときに生成される固有の認証トークンです。

## イベントのパブリッシュ
{: #publishing_events}

デバイスは、以下の形式でイベント・トピックにパブリッシュします。

<pre class="pre">iot-2/evt/<var class="keyword varname">event_id</var>/fmt/<var class="keyword varname">format_string</var></pre>
{: codeblock}

説明

-  **event_id** は、イベントの ID です (例えば `status`)。イベント ID には、MQTT で有効な任意のストリングを設定できます。ワイルドカードが使用されない場合、サブスクライバー・アプリケーションは、サブスクリプション・トピックでこのストリングを使用し、トピックでパブリッシュされるイベントを受け取る必要があります。
-  **format_string** は、イベント・ペイロードの形式です (例えば `json`)。形式は、MQTT で有効な任意のストリングとなります。ワイルドカードが使用されない場合、サブスクライバー・アプリケーションは、サブスクリプション・トピックでこのストリングを使用し、トピックでパブリッシュされるイベントを受け取る必要があります。

**重要:** メッセージ・ペイロードは最大 131072 バイトに制限されます。この制限を超えるメッセージは拒否されます。


## コマンドへのサブスクライブ
{: #subscribing_to_commands}

デバイスは、以下の形式でコマンド・トピックにサブスクライブできます。

<pre class="pre">iot-2/cmd/<var class="keyword varname">command_id</var>/fmt/<var class="keyword varname">format_string</var></pre>
{: codeblock}

説明
 - **command_id** は、コマンドの ID です (例えば `update`)。コマンド ID には、MQTT プロトコルで有効な任意のストリングを設定できます。ワイルドカードが使用されない場合、デバイスは、サブスクリプション・トピックでこのストリングを使用し、トピックでパブリッシュされるコマンドを受け取る必要があります。
 - **format_string** は、コマンド・ペイロードの形式です (例えば `json`)。形式には、MQTT プロトコルで有効な任意のストリングを設定できます。ワイルドカードが使用されない場合、デバイスは、サブスクリプション・トピックでこのストリングを使用し、トピックでパブリッシュされるコマンドを受け取る必要があります。

デバイスを他のデバイスからのイベントにサブスクライブすることはできません。デバイスは、その独自のデバイスだけにパブリッシュされるコマンドを受け取ります。

## 管理対象デバイス
{: #managed-devices}

デバイス・ライフサイクル管理のサポートはオプションです。デバイス管理プロトコルは、デバイスがイベント/コマンド制御で既に使用していたものと同じ MQTT 接続を使用します。

### サービス品質レベルとクリーン・セッション

管理対象デバイスは、サービス品質 (QoS) レベルが 0 か 1 のメッセージをパブリッシュすることができます。デバイスからのメッセージは、保存メッセージであってはなりません。

QoS=0 のメッセージは破棄される可能性があり、メッセージ・サーバーを再始動した後には保持されません。QoS=1 のメッセージはキューに入れられる可能性があり、メッセージ・サーバーを再始動した後にも残ります。要求がキューに入れられるかどうかは、サブスクリプションの耐久性によって異なります。サブスクリプションの耐久性は、サブスクリプションを作成した接続の `cleansession` パラメーターによって決まります。  

{{site.data.keyword.iot_short_notm}} は、メッセージのキューイングをサポートするために QoS レベルが 1 の要求をパブリッシュします。管理対象デバイスが接続されていなかった間に送信されるメッセージをキューに入れるには、`cleansession` パラメーターを false に設定することにより、デバイスがクリーン・セッションを使用しないようデバイスを構成します。

**警告:** 管理対象デバイスが永続サブスクリプションを使用する場合、要求がタイムアウトになる前にデバイスがサービスに再接続しなければ、オフラインの間にデバイスに送信されるデバイス管理コマンドは、失敗した操作として報告されます。
ただし、デバイスが再接続すると、それらの要求はデバイスによって処理されます。永続サブスクリプションは、`cleansession=false` パラメーターによって指定されます。

### トピック

{{site.data.keyword.iot_short_notm}} サービスからの要求と応答を処理するために、管理対象デバイスは次のトピックをサブスクライブする必要があります。

```
iotdm-1/#
```


管理対象デバイスは、実行されている管理要求のタイプに固有のトピックにパブリッシュします。

- 管理対象デバイスは、`iotdevice-1/response` でデバイス管理応答をパブリッシュします。
- 管理対象デバイスのパブリッシュ先となる可能性があるその他のトピックについては、[デバイス管理プロトコル](device_mgmt/index.html)と[デバイス管理要求](device_mgmt/requests.html)を参照してください。



### メッセージ形式

すべてのメッセージは JSON 形式で送信されます。

**要求**  
要求は、以下のコード・サンプルで示されるように形式設定されます。

<pre class="pre">{  "d": {...}, "<var class="keyword varname">reqId</var>": "b53eb43e-401c-453c-b8f5-94b73290c056" }</pre>
{: codeblock}

説明:

 - **d** は、要求に関連したデータを運びます。
 - **reqId** は、要求の ID であり、応答にコピーする必要があります。応答が不要な場合は、*reqId* フィールドを省略することができます。

**応答**  
応答は、以下のコード・サンプルで示されるように形式設定されます。
```
        {
            "rc": 0,
            "message": "success",
            "d": {...},
            "reqId": "b53eb43e-401c-453c-b8f5-94b73290c056"
        }
```
説明:  
 - **rc** は、元の要求の結果コードです。
 - **message** は、オプション要素で、応答コードのテキスト記述が入ります。
 - **d** は、応答が伴うオプションのデータ要素です。
 - **reqId** は、元の要求の要求 ID です。これは、応答を要求と相関させるために使用されます。デバイスは、すべての要求 ID が固有であることを確認する必要があります。{{site.data.keyword.iot_short_notm}} 要求に対する応答には、正しい **reqId** 値を含める必要があります。

特定の要求メッセージや応答メッセージについて詳しくは、[デバイス管理プロトコル](device_mgmt/index.html)と[デバイス管理要求](device_mgmt/requests.html)を参照してください。
